name: Build for Apple platforms

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]

env:
  DEVELOPMENT_TEAM: "8J6VSUTQNX"
  SDK: "iphoneos"
  SDK_VERSION: "16.0"

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      #cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
      run: |
        mkdir build && cd build
        cmake .. \
            -G Xcode \
            -DIOS=1 \
            -DCMAKE_OSX_SYSROOT=$(xcrun --sdk $SDK --show-sdk-path) \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=$SDK_VERSION \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_LIBRARY_TYPE=Static \
            -DUSE_FREETYPE=0 \
            -DUSE_FREEIMAGE=0 \
            -DUSE_OPENVR=0 \
            -DUSE_OPENGL=0 \
            -DUSE_GLES2=0 \
            -DUSE_RAPIDJSON=0 \
            -DUSE_DRACO=0 \
            -DUSE_TK=0 \
            -DUSE_TCL=0 \
            -DUSE_TBB=0 \
            -DUSE_VTK=0
        mkdir xcarchives

    - name: Build for iOS
      env:
        PLATFORM: "iOS"
      run: |
        xcodebuild archive \
            -project OCCT.xcodeproj \
            -scheme ALL_BUILD \
            -destination generic/platform=$PLATFORM \
            -archivePath "xcarchives/OCCT-$PLATFORM.xcarchive" \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            ARCHS='$(ARCHS_STANDARD)' \
            BUILT_PRODUCTS_DIR='$(CONFIGURATION_BUILD_DIR)'\
            INSTALL_DIR='$(DSTROOT)$(INSTALL_PATH)' \
            DEVELOPMENT_TEAM=$DEVELOPMENT_TEAM

    - name: Merge frameworks
      run: |
        for ARCHIVE in $(ls xcarchives/*.xcarchive)
        do
            libtool -static -o xcarchives/$ARCHIVE/Products/usr/local/lib/occt.a xcarchives/$ARCHIVE/Products/usr/local/lib/*.a
        done
    # lipo -create xcarchives/OCCT-iOS-Simulator-*.xcarchive/Products/usr/local/lib/occt.a -output occt-simulator.a
    
    - name: Copy header files
      # Resolves the header files to find their actual contents and copies them to the 'xcheaders/opencascade' directory.
      run: |
        mkdir -p xcheaders/opencascade
        cp $(sed -nr 's/\#include "(.*)"/\1/p' ../include/opencascade/*) ./xcheaders/opencascade/

    - name: Create xcframework
      run: |
        mkdir xcframeworks
        xcodebuild -create-xcframework \
          -library xcarchives/OCCT-iOS.xcarchive/Products/usr/local/lib/occt.a \
          -headers xcheaders/opencascade \
          -output xcframeworks/occt.xcframework

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: occt.xcframework
        path: xcframeworks/occt.xcframework
